---
title: "Test de hipótesis para una población normal"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introducción y test de hipótesis de dos colas

### Homeopatía y pérdida de 

Un producto homeopático afirma que **"gracias a su uso, perderás 2 Kg en dos semanas"**.

Escéptico ante esta afirmación, reclutas a 50 personas de tu ciudad para participar
en un experimento. Las personas usan el producto homeopático durante dos semanas
y reportan su pérdida de  (por ejemplo, $x_i=3$ significaría que se han perdido
3 Kg, mientras que $x_i=-3$ significaría que se han ganado 3). Datos en 
"homeo\_weight\_loss.csv".

En base a los datos, ¿es creible la afirmación del producto homeopático? Por sencillez, 
asume que la pérdida de  tiene desviación típica poblacional $\sigma=2.5$.

```{r}
# ??
```

### Homeopatía y pérdida de : T-test

En el ejercicio anterior hemos asumido que $\sigma$ es conocida. Como sabemos,
esto ocurre muy rara vez en la práctica.

Repite el test de hipótesis para el problema de la pérdida de  si $\sigma$
es desconocida. ¿Cuál sería tu conclusión?

```{r}
# ??
```


### $H_0$ no demuestra nada
Interpreta el siguiente fragmento de código...

```{r}
set.seed(42)
x <- rnorm(30, mean = 0, sd = 5)
print(c(
  t.test(x, mu = 1)$p.value, 
  t.test(x, mu = -1)$p.value
))
```

### Es posible cometer errores en los test de hipótesis (conclusiones incorrectas)
```{r}
set.seed(4)
x <- rnorm(30, mean = 0, sd = 5)
print(
  t.test(x, mu = 0)$p.value
)
```

### Interpretación de $\alpha$
Completa el siguiente fragmento de código para verificar la siguiente interpretación
de $\alpha$: Si repetimos el test muchas veces,
**rechazaremos la $H_0$ siendo esta correcta un $\alpha$\% de veces**

```{r}
N <- 5000
alpha <- 0.05
alpha = 0.01 # cuanto menor sea menos prob de rechazar la H0

sims <- replicate(N, {
  # H0: mu = 0
  x <- rnorm(100, mean = 0)            # Genera muestras de H0 (H0 es correcta)
  test <- t.test(x, mu = 0)$p.value    # Testea H0
  # Añade condición de éxito para calcular la probabilidad de
  # "Rechazar H_0 a pesar de ser correcta"
  
  p_value < alpha 
  
})
print(paste("alpha =", alpha, "| p(incorrectly reject H0) = ", mean(sims)))
```

# Test de hipótesis de una sola cola y tamaño del efecto

### Test de una sola cola 
Un producto homeopático afirma que "gracias a su uso, perderás **al menos** 2 Kg en dos semanas"...
¿Es creíble esta afirmación?

```{r}

View(new_york)
library(readr)
homeo_weight_loss <- read_csv("C:/Users/machi/Downloads/CEU/segundo año/estadistica/data_2/homeo_weight_loss.csv")
# View(homeo_weight_loss)

# 1.- formulamos la hipotesis:
  
  # H0: "gracias a su uso perderas 2kg"
  # Ha, H1: "el uso del producto no conlleva la perdida de 2kg"
  
  # H0: mu = 2kg     }
  # Ha: mu != 2kg    } --> de perdida de 

# 2.- buscar un estadistico de contraste:
  
  #' para adivinar la mu X_gorrito (mean)
  #' X_gorrito = N(µ, σ ^ 2 / n)
    #' se tiene q asumir / comprobar: muestreo aleatorio simple? o poblacion infinita?
    #' 1.- las personas de mi ciudad usan homeopatia >> 50 
    #'     puedo asumir poblacion infinita
    #' 2.- observando el histograma, observo que X es normal
    bins = nclass.FD(homeo_weight_loss$weight_loss_Kg)
    ggplot(homeo_weight_loss, aes(x = weight_loss_Kg)) + 
      geom_histogram(bins = bins)
  #' como se cumplen ambas puedo asumir: X_gorrito = N(µ, σ ^ 2 / n)
  #' bajo la hipotesis nula (asumimos cierta): (mu = 2, σ = 2.5, n = 50) -- datos del enunciado
  #' X_gorrito = N(2, 2.5 ^ 2 / 50)
#' 3.- calculamos p-valor (confrontar datos Vs H0)
  x_axis = seq(0, 5, by = 0.01)
  y_axis = dnorm(x_axis, mean = 2, sd = sqrt(2.5 ^ 2 / 50))
  plot(x_axis, y_axis, type = "l")
  
  x_mean = mean(homeo_weight_loss$weight_loss_Kg)
  x_mean
  abline(v = x_mean, col = "red")
  
  # p-valor: obtener un evento tan o mas extremo q el observado
  # compatibles com Ha
  # P(X_gorrito > 0.037)  ---->  2 * P(X_gorrito > 0.037)   por simetria
  abline(v = 4 - 0.037, col = "green")
  p_valor = 2 * pnorm(0.037, 2, sqrt(2.5 ^ 2 / 50))
  p_valor

# 4.- comparamos el p-valor con un umbral llamado nivel de significancia alpha: 0.01
  #' si p-valor < 0.01 ---> aceptamos H1, rechazamos H0 (trozaco mierda)
  #' si p-valor > 0.01 ---> aceptamos H0, rechazamos Ha (trozaco mierda)
  
  #' si el p-valor es < 0.01 ---> los datos apoyan la H1, mientras q H0 es poco veraz.
  #' si el p-valor es > 0.01 ---> los datos no apoyan la H1, 
  #'                              no hay sudiciente evidencia para afirmar H1.
  
  #' en este caso ---> los datos poyan la Ha, que mu != 2. (NO VAS A PERDES 2KG EN DOS SEMANAS)
  
  
### MISMO PROBLEMA PERO SIN CONOCER SIGMA: -----------------------------------
  #' 1.- H0: mu = 2
  #'     Ha: mu != 2
  #' 2.- distribucion de estadistico
  #' las asunciones acerca d epoblacion inf y noramlidad se mantienen:
  #'  (X_gorrito - mu) / (S / sqrt(n)) ~ T(n - 1)
  t.test(homeo_weight_loss$weight_loss_Kg, mu = 2)
  # como p_valor es muy pequeño los datos apoyan a  Ha, (homeopatia es un timo)
  
## otras cosas mas:
  x_mean = mean(homeo_weight_loss$weight_loss_Kg)
  x_sd = sd(homeo_weight_loss$weight_loss_Kg)
  n = nrow((homeo_weight_loss))
  
  # calculamos el estadistico de contraste asumiendo q H0 es cierta
  mu = 2
  t_contraste = (x_mean - mu) / (x_sd / sqrt(n)) # ---> -5.255273
  
  x_axis = seq(-6, 6, by = 0.1)
  plot(x_axis, dt(x_axis, df = n - 1), type = "l")
  abline(v = t_contraste, col = 2, lwd = 2)
  
  t.test(homeo_weight_loss$weight_loss_Kg, mu = 2)
  # t = t_contraste
  # calcular a partir de t_contraste, p_valor
  2 * pt(t_contraste, df = 49)

```
```{r}

x_axis = seq(-6, 6, by = 0.1)
plot(x_axis, dt(x_axis, df = n - 1), type = "l")
abline(v = t_contraste, col = 2, lwd = 2)

pt(t_contraste, 49)  # NO hace falta multiplicar por 2

# 1.- escribir las hipotesis
# 2.- hayar un estadistico cuya dist. conozcamos 
  # dos consideraciones: independencia y normalidad...

  my_test = t.test(homeo_weight_loss$weight_loss_Kg, alternative = "less", mu = 2)
  my_test$p.value

# p_valor = 1.603e-06
# aceptamos H1 --> los datos apoyan q la perdida de  es menor q 2kg. la afirmacion del homeopata no se sostiene

```

A este tipo de problemas se les conoce como **hipótesis de una sola cola**
(Vs. **hipótesis de dos colas**).

### Fármaco para pérdida de 
Gracias a tu éxito con el análisis del producto homeopático, una farmacéutica
interesada en desarrollar un fármaco para la pérdida de  te contrata.
La empresa quiere comercializar su (carísimo) producto con un eslogan del tipo
"Hay evidencia científica de nuestro producto te hará perder  si lo usas dos meses".

Te facilitan los datos de "pharma\_weight\_loss.csv". ¿Hay suficiente evidencia
de que el fármaco te hace perder ? (Usa $\alpha=0.05$.)

```{r}

#' H0: mu < 0
#' Ha: mu > 0 ---> quiero demostrar lo contrario (mu < 0)

### CORRECCION TINO:
  library(readr)
  pharma_weight_loss <- read_csv("C:/Users/machi/Downloads/CEU/segundo año/estadistica/data_2/pharma_weight_loss.csv")
  # 2.- encontrarun estadistico...
  # se deben cumplir dos condiciones para usar t.test: 
    # poblacion infinita --> independencia entre muestras     
      # la poblacion es ersona q pueden llegar a usar un producto de perdida de 
      # la muestra es pequeña con respecto a esta poblacion
    # distribucion normal --> es razonable en vista al histograma
  library("tidyverse")
  
  nbins = nclass.FD(pharma_weight_loss$weight_loss_Kg)
  ggplot(pharma_weight_loss, aes(x = weight_loss_Kg)) + geom_histogram(bins = nbins)
  # Ha: mu > 0
  my_ttest = t.test(pharma_weight_loss$weight_loss_Kg, alternative = "greater", mu = 0)
  # p_valor: 0.0003103 ---> aceptaas la Ha.
  # comparar el p_valor con alpha (0.05) y por eso aceptamos la Ha.
  # la conclusion seria: los datosapoyan q hay una perdida de . En media, se pierden 100mg.
  

```
¿Tú crees que alguien comprará el producto?
**No hay que confundir la significancia estadística con la relevancia práctica**.
Para esto último debemos usar **ICs** o **el tamaño del efecto**.

### Tamaño del efecto
Calcula el tamaño del efecto para el problema del fármaco. ¿Cómo lo interpretas?
Usa la siguiente [tabla]{https://imaging.mrc-cbu.cam.ac.uk/statswiki/FAQ/effectSize}.

```{r}
# para calcualr la relevancia del resultado:
weights = pharma_weight_loss$weight_loss_Kg
# numeros pequeños son poco relevantes
mean(weights) / sd(weights)

library("effectsize")  # install.packages("effectsize")
cohens_d = effectsize(my_t.test)  # tamaño del efecto es pequeño pq es menor a 0.2 (tabla traspas)
                                  # resultado poco relevante
# Estamos 95% seguros de q la perdida de  media es superior a 0.055

```

Siempre que hagas un test de medias, 
**usa el tamaño del efecto o ICs para complementar los p-valores**.

### ICs unilaterales
Calcula el **IC unilateral** asociado al test.

```{r}
# Estamos 95% seguros de q la perdida de  media es superior a 0.055
print(...)
```

# --------------------------------------------------------------------------------
como reportar resultados??
los datos apoyan q hay una perdida de  gracias al uso del producto (p_valor = 0.0003)
sin embargo el tamaño del efecto es pequeño 0.11. lo q nos indica q la perdida de  es             poco relevante (con 95% confianza, la perdida es mayoa a 0.05kg).
# --------------------------------------------------------------------------------

### Test para la varianza
Los test de cociente intelectual (CI) están diseñados para que la desviación típica
poblacional sea de 15 puntos. Sin embargo, en los procesos de traducción de
un test "oficial" de CI pueden surgir desajustes.

Por ejemplo, "iq\_spanish.csv" tiene los resultados de un test de CI
traducido del inglés al español. ¿Hay evidencia de que la desviación típica
es distinta de 15 y de que, por tanto, debe revisarse la traducción? Usa un nivel
de significación del 5\%.

```{r}
# 1.- discutir hipotesis:
  # H0: sigma^2 = 15^2
  # Ha: sigma^2 != 15^2
    # prueba de 2 colas
# 2.- buscar estadistico para las hipotesis:
  # usamos S_gorrito (sd()) para estimar la desviacion tipica poblacional
  # (n - 1) S_gorrito^2 / sigma^2 ~ X^2_(n - 1)   ---> chi cuadrado
  # discutir cosas q se tiene q cumplir:
    # muestras independientes
      # la gente en este ejemplo la poblacion son los españoles y latam 
      # muestra de 30 personas es muy pequea con la poblacion por lo q se puede razonar p.infinita
      # e independencia
    # sea normal (los iq de los españoles)
      nbins = nclass.FD(iq_spanish$iq)
      ggplot(iq_spanish, aes(x = iq)) + geom_histogram(bins = nbins)
        # buscar varianza muestral   (ns si esta bien)
          iqs = iq_spanish$iq
          mean(iq) / sd(iq)
          var(iq_spanish$iq) # 388.7
      # asumir q la H0 es cierta (H0: varianza = 15^2)
          # (30 - 1)S_gorrito / 15^2 ~ X^2_(29)
# 3.- calcular el p_valor
  valor = (30 - 1) * 388.7 / 15^2  # ---> 50.1
    # representar X^2(29) y poner la linea de 50.1
  x_axis = seq(0, 100, by = 0.1)
  plot(x_axis, dchisq(x_axis, df = 29), type = "l")
  abline(v = valor, col = 2, lwd = 2)
  # p_valor = P(X^2_(29) > 50.1) = 1 - P(X^2_(29) <= 50.1)  SIEMPRE MULTIPLICAR POR 2 EN PRUEBAS DE 2 COLAS
  p_valor = 2 * (1 - pchisq(50.1, 29))   # ---> 0.01762036
# 4.- coparar el p_valor con alpha (0.05)
  # es menor por lo q aceptamos Ha. 
  # rechazamos la H0.
# CONCLUSION: los datos apoyan que la varianza es distinta de 15^2 (revisar traduccion (con mas muestras))
  # si fuera al reves el resultado tmb. (no revisariamos la traduccion)
  
  
  
```

Lo razonable sería repetir el experimento con más muestras. Ahora bien,
¿con cuántas?


### Potencia de un test
Como $\hat{s}^2=388.6902$, escribe una función que calcule la probabilidad de
rechazar $H_0$ si $\sigma^2=388.6902$ para un número de muestras $n$. Completa
el siguiente código:

```{r}
power_var_test <- function(n, H0_sigma2 = 15 ^ 2, true_sigma2 = 388.6902,
                           significance = 0.05, N = 5000) {
  sims <- replicate(N, {
    data <- rnorm(n, sd = sqrt(true_sigma2))           # datos donde Ha es cierta
    var_stat <- (n - 1) * var(data) / (15 ^ 2)         # 
    p_value <-   2 * (1 - pchisq(var_stat, df = n - 1)) # 
    p_value < significance                              # TRUE si rechazo la H0 (acepto Ha)
  })
  mean(sims)   # P(aceptar HA | Ha es cierta (sigma^2 = 388.6902))
}

power_var_test(10)    # 0.2708 = 27%


```

### Potencia de un test: tamaño de la muestra
Halla ahora el número de muestras necesarias para obtener una potencia de test
del 90\%.

```{r}
power_var_test = Vectorize(power_var_test)
ns = seq(10, 80, by = 10)
power_values = power_var_test(ns)
plot(ns, power_values, type = "o")
abline(h = 0.9, col = 2, lty = 2)

```

### Potencia del T-test: número de muestras
Según la estadísticas oficiales, la media de  de las mujeres de cierto país
es de 63.5 Kg (con desviación típica 4.1). Sin embargo, un equipo de 
investigadores cree que debido a cambios en la alimentación la media se ha 
incrementado. ¿Cuántas muestras necesitarán para poder detectar un incremento de
medio Kg con un nivel de significación del 1\% y una potencia del 90\%? Usa 
*power.t.test*.

```{r}
power.t.test(
  delta = 0.5, 
  sd = 4.1,
  sig.level = 0.01, # alpha
  power = 0.9,
  type = "one.sample",
  alternative = "one.sided"
  )
# nuestro estudio deberia recorrerse con 878 muestras (al hacer el power.t.test)

```
